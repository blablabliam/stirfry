<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="üßù Georgie Sightings" />
<title>üßù Georgie Sightings</title>
<style>
   html { height:100vh; }
   body { height:100vh; width:100vw; margin:0px; }
   #nav { font:500 10pt Sans-serif; height:20px; color:black; background:yellowgreen; }
   #mapid { display:block; width:100vw; height:calc(100vh - 20px); background:darkgray; }
   p { margin:0px; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
<!--<script src="https://platform.twitter.com/widgets.js"></script>//-->
<script>

// debug grid example from https://leafletjs.com/examples/extending/extending-2-layers.html
L.GridLayer.DebugCoords = L.GridLayer.extend({
   createTile: function (coords) {
      var tile = document.createElement('div');
      tile.innerHTML = [coords.x, coords.y, coords.z].join(', ');
      tile.style.outline = '1px solid red';
      return tile;
   }
});
L.gridLayer.debugCoords = function(opts) {
   return new L.GridLayer.DebugCoords(opts);
};

</script>
</head>
<body>
<div id="nav">
   <p>üßù Georgie Sightings:</p>
</div>
<div id="mapid"></div>

<script>

//get parameters from the url

// Stamen layers
var s_stamen_copyright = 'Map tiles by <a href="https://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://www.openstreetmap.org/copyright">ODbL</a>.'; // used for all sets except Watercolor
var s_stamen_urlbase = 'https://stamen-tiles-{s}.a.ssl.fastly.net/';
var l_stamen_watercolor = L.tileLayer(s_stamen_urlbase+'watercolor/{z}/{x}/{y}.jpg',{maxZoom:20, attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'});
var l_stamen_terrain = L.tileLayer(s_stamen_urlbase+'terrain/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainbg = L.tileLayer(s_stamen_urlbase+'terrain-background/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlines = L.tileLayer(s_stamen_urlbase+'terrain-lines/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlabels = L.tileLayer(s_stamen_urlbase+'terrain-labels/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_toner = L.tileLayer(s_stamen_urlbase+'toner/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlite = L.tileLayer(s_stamen_urlbase+'toner-lite/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerbg = L.tileLayer(s_stamen_urlbase+'toner-background/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerhybrid = L.tileLayer(s_stamen_urlbase+'toner-hybrid/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlines = L.tileLayer(s_stamen_urlbase+'toner-lines/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlabels = L.tileLayer(s_stamen_urlbase+'toner-labels/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});

// OpenStreetMaps & OpenTopoMap
var l_osm_fr = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {maxZoom:20, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="https://openstreetmap.fr">OSM France</a>'});
var l_osm_hot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {maxZoom:19, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - Tiles courtesy of <a href="https://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'});
var l_otm = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxNativeZoom:17, attribution:'Kartendaten: &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>-Mitwirkende, SRTM | Kartendarstellung: &copy; <a href="http://opentopomap.org/">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});

//debug layer
var l_debug = L.gridLayer.debugCoords();

// create map, and set default center coordinates, zoom level, and layers
var mymap = L.map('mapid', {
   center: [29.71475,-95.3888],
   zoom: 15,
   layers: [l_osm_hot],
   doubleClickZoom: false
});

// define available basemaps (can view only one at a time)
var basemaps = {
   "Stamen Watercolor": l_stamen_watercolor,
   "Stamen Terrain Terrain": l_stamen_terrain,
   "Stamen Terrain Background": l_stamen_terrainbg,
   "Stamen Toner": l_stamen_toner,
   "Stamen Toner Background": l_stamen_tonerbg,
   "Stamen Toner Lite": l_stamen_tonerlite,
   "OpenTopoMap": l_otm,
   "OpenStreetMap France": l_osm_fr,
   "OpenStreetMap Humanitarian": l_osm_hot,
};

// define available overlay maps (can view more than one at a time, arranged in order from lowest to highest)
var overlaymaps = {
   "Stamen Terrain Lines": l_stamen_terrainlines,
   "Stamen Toner Lines": l_stamen_tonerlines,
   "Stamen Toner Hybrid": l_stamen_tonerhybrid,
   "Stamen Terrain Labels": l_stamen_terrainlabels,
   "Stamen Toner Labels": l_stamen_tonerlabels,
   "Debug Grid":l_debug,
};

// add a layer selector control and scale bar
L.control.layers(basemaps, overlaymaps).addTo(mymap);
L.control.scale().addTo(mymap);

let twttrpuburl = 'https://publish.twitter.com/oembed';
let twttrpubparam = '?url=https://twitter.com/hermannpark/status/';

function fgetScript(source, callback) {
    var script = document.createElement('script');
    var prior = document.getElementsByTagName('script')[0];
    script.async = 1;
    script.onload = script.onreadystatechange = function( _, isAbort ) {
        if(isAbort || !script.readyState || /loaded|complete/.test(script.readyState) ) {
            script.onload = script.onreadystatechange = null;
            script = undefined;
            if(!isAbort) { if(callback) callback(); }
        };
    };
    script.src = source;
    prior.parentNode.insertBefore(script, prior);
};

function fgettweethtml(id) {
   return fetch(twttrpuburl+twttrpubparam+id)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+': '+response.statusText); };
         return response.json();
      })
      .then((data) => { return data.html; })
      .catch((err) => { console.error(err); });
};

mymap.on('popupopen', function(e) {
    fgetScript("https://platform.twitter.com/widgets.js");
    var px = mymap.project(e.popup._latlng); // find the pixel location on the map where the popup anchor is
    px.y -= e.popup._container.clientHeight; // find the height of the popup container, divide by 2, and subtract from the Y axis of marker location
    mymap.panTo(mymap.unproject(px),{animate: true}); // pan to new center
});

var tweetarray = [
   {id:'1201233312976642049',lat:29.721452,lng:-95.390876,descr:'Sam Houston'},
   {id:'1201520255102857217',lat:29.720247,lng:-95.391119,descr:'Reflection Pool'},
   {id:'1201901368891584512',lat:29.719219,lng:-95.38491,descr:'Conservancy Office'},
];

for (i=0;i<tweetarray.length;i++) {
   var prom0 = Promise.resolve(tweetarray[i]);
//   var prom1 = fgettweethtml(tweetarray[i].id);
   var prom1 = Promise.resolve("\u003Cblockquote class=\"twitter-tweet\"\u003E\u003Cp lang=\"en\" dir=\"ltr\"\u003EYa boy Georgie here, on this beautiful \u003Ca href=\"https:\/\/twitter.com\/hashtag\/GivingTuesday?src=hash&amp;ref_src=twsrc%5Etfw\"\u003E#GivingTuesday\u003C\/a\u003E. And listen: as an elf, I‚Äôve got a list of gifts to buy that‚Äôs a mile long. So I‚Äôm using HPC‚Äôs Holiday Gift Guide to check my list (twice, duh) AND give back to my favorite Park. Check out the list at \u003Ca href=\"https:\/\/t.co\/c8VUElX9Jc\"\u003Ehttps:\/\/t.co\/c8VUElX9Jc\u003C\/a\u003E. \u003Ca href=\"https:\/\/t.co\/FTAzOQFqW0\"\u003Epic.twitter.com\/FTAzOQFqW0\u003C\/a\u003E\u003C\/p\u003E&mdash; Hermann Park (@HermannPark) \u003Ca href=\"https:\/\/twitter.com\/HermannPark\/status\/1201901368891584512?ref_src=twsrc%5Etfw\"\u003EDecember 3, 2019\u003C\/a\u003E\u003C\/blockquote\u003E\n\u003Cscript async src=\"https:\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"\u003E\u003C\/script\u003E\n");
   Promise.all([prom0,prom1]).then(function(values) {
      var lat = values[0].lat;
      var lng = values[0].lng;
      var tweetid = values[0].id;
      var tweethtml = values[1];
      L.marker([lat,lng])
      .addTo(mymap)
      .bindPopup(tweethtml,{maxWidth:275});
   });  
};
/*
twttr.widgets.ready;
twttr.widgets.createTweet(
  tweetarray[1].id,
  document.getElementById('tweetbox')
);
*/

</script>
</body>
</html>