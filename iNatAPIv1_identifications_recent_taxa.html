<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="iNaturalist Identification Recent Taxa" />
<title>iNaturalist Identification Recent Taxa</title>
<style>
   body { font:10pt Sans-Serif; }
   .tar { text-align:right; }
   #main { width:100%; }
   table, thead, tbody, tr, td { margin:0px; padding:3px; border-width:1px 0px;border-style:solid; border-color:lightgray; border-spacing:0px; border-collapse:collapse; }
   thead tr { font-weight:600; background:green; color:white; }
   tfoot tr { font-weight:600; background:black; color:white; }
   tr { background:whitesmoke; }
   tr:nth-child(even) {background-color:white }
   .icon { height:48px; width:48px; border-radius:50%; }
   img { margin:0px; padding:0px; border:0px; }
   a { text-decoration:none; }
   .button { font-size:18pt; }
   .button_inactive { font-size:18pt; opacity:0.5; }
</style>
</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
var winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
//var p_per_page = winurlparams.get('per_page') || 10;
//var p_page = winurlparams.get('page') || 1;

function furl(url,txt=url) { return '<a href="'+url+'">'+txt+'</a>'; };
function famp(str) { return str.replace(/&/g,'&amp;'); };
function fcomnum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',') };
function fpct(d,p=1) {
   x = d*100;
   return x.toFixed(p);
};
//reformat an ISO formatted date string
function fdate(str) {
   if (str!==null) {
      str = str.replace(/t/i,' '); //replaces T (case insensitive) with a space
      str = str.replace(/([+-]\d{2}\:?\d{2})/,' ($1)'); //puts parenthesis around time zone offset
      str = str.replace(/z/i,' (+00:00)'); //replaces Z (case insensitve) with UTC
      str = str.replace('+00:00','±00:00');   };
   return str;
};

function faddelem(etype,eparent,eclass=null,eid=null,ehtml=null) {
   var eobj = document.createElement(etype);
   if (eclass!==null) { eobj.classList = eclass };
   if (eid!==null) { eobj.id = eid };
   if (ehtml!==null) { eobj.innerHTML = ehtml };
   eparent.appendChild(eobj);
   return eobj;
};
function fpageurl(urlbase,urlparams,per_page,page) {
   var params = new URLSearchParams(urlparams);
   var url_per_page = params.get('per_page');
   var url_page = params.get('page');
   (url_per_page===null) ? params.append('per_page',per_page) : params.set('per_page',per_page);
   (url_page===null) ? params.append('page',page) : params.set('page',page);
   return urlbase+'?'+params;
};
function fresults(xobj) {
//   faddelem('p',document.body,null,null,furl(famp(apiurl)));
   var results = xobj.results;
   if (results) {
      var total_results = xobj.total_results;
      var per_page = xobj.per_page;
      var page_curr = xobj.page;
      var page_max = Math.ceil(total_results/per_page);
      var page_prev = ((page_curr>1)?page_curr-1:null);
      var page_next = ((page_curr<page_max)?page_curr+1:null);

      faddelem('p',document.body,null,null,'total records: '+fcomnum(total_results)+'<br />'
         +'per page: '+fcomnum(per_page)+'<br />'
         +'page: '+fcomnum(page_curr)+' of '+fcomnum(page_max)+'<br />'
         +'all results available: '+xobj.all_results_available
         );

      // table headers
      var table = faddelem('table',document.body,null,'main');
      var thead = faddelem('thead',table);
      var hrow = faddelem('tr',thead);
      faddelem('td',hrow,null,null,'Rec #');
      faddelem('td',hrow,null,null,'Taxon Photo');
      faddelem('td',hrow,null,null,'Taxon Name');
      faddelem('td',hrow,null,null,'Taxon Common Name');
      faddelem('td',hrow,null,null,'Taxon Rank');
      faddelem('td',hrow,null,null,'Taxon = ID Taxon');
      faddelem('td',hrow,null,null,'ID #');
      faddelem('td',hrow,null,null,'ID User Photo');
      faddelem('td',hrow,null,null,'ID User Login');
      //faddelem('td',hrow,null,null,'ID User Name');
      faddelem('td',hrow,null,null,'ID Datetime');
      faddelem('td',hrow,null,null,'ID Category');
      //faddelem('td',hrow,null,null,'ID via Taxon Change');
      faddelem('td',hrow,null,null,'ID via Comp Vision');
      faddelem('td',hrow,null,null,'ID on Own Obs');
      faddelem('td',hrow,null,null,'Obs #');
      faddelem('td',hrow,null,null,'Obs Grade');
      //faddelem('td',hrow,null,null,'Obs User Photo');
      //faddelem('td',hrow,null,null,'Obs User Login');
      //faddelem('td',hrow,null,null,'Obs User Name');
      faddelem('td',hrow,null,null,'Obs Observed');
      faddelem('td',hrow,null,null,'Obs Submitted');
      faddelem('td',hrow,null,null,'Obs Taxon Photo');
      faddelem('td',hrow,null,null,'Obs Taxon Name');
      //faddelem('td',hrow,null,null,'Obs Taxon Common Name');
      //faddelem('td',hrow,null,null,'Obs Taxon Rank');
      faddelem('td',hrow,null,null,'ID Taxon = Obs Taxon');

      // table rows
      var tbody = faddelem('tbody',table);
      for (i=0;i<results.length;i++) {
         var brow = faddelem('tr',tbody);
         faddelem('td',brow,null,null,i+1);
         faddelem('td',brow,null,null,'<img class="icon" src="'+(results[i].taxon.default_photo?results[i].taxon.default_photo.square_url:'')+'" />');
         faddelem('td',brow,null,null,furl('https://www.inaturalist.org/taxa/'+results[i].taxon_id,results[i].taxon.name));
         faddelem('td',brow,null,null,results[i].taxon.preferred_common_name);
         faddelem('td',brow,null,null,results[i].taxon.rank);
         faddelem('td',brow,null,null,(results[i].taxon_id===results[i].identification.taxon.id?'✔':'❌'));
         faddelem('td',brow,null,null,furl('https://www.inaturalist.org/identifications/'+results[i].identification.id,results[i].identification.id));
         faddelem('td',brow,null,null,'<img class="icon" src="'+results[i].identification.user.icon+'" />');
         faddelem('td',brow,null,null,furl('https://www.inaturalist.org/people/'+results[i].identification.user.login,results[i].identification.user.login));
         //faddelem('td',brow,null,null,results[i].identification.user.name);
         faddelem('td',brow,null,null,fdate(results[i].identification.created_at));
         faddelem('td',brow,null,null,results[i].identification.category);
         //faddelem('td',brow,null,null,(results[i].identification.taxon_change?'✔':'❌'));
         faddelem('td',brow,null,null,(results[i].identification.vision?'✔':'❌'));
         faddelem('td',brow,null,null,(results[i].identification.own_observation?'✔':'❌'));
         faddelem('td',brow,null,null,furl('https://www.inaturalist.org/observations/'+results[i].identification.observation.id,results[i].identification.observation.id));
         faddelem('td',brow,null,null,results[i].identification.observation.quality_grade);
         //faddelem('td',brow,null,null,'');
         //faddelem('td',brow,null,null,furl('https://www.inaturalist.org/people/'+results[i].identification.observation.user.login,results[i].identification.observation.user.login));
         //faddelem('td',brow,null,null,results[i].identification.observation.user.name);
         faddelem('td',brow,null,null,fdate(results[i].identification.observation.time_observed_at));
         faddelem('td',brow,null,null,fdate(results[i].identification.observation.created_at));
         faddelem('td',brow,null,null,'<img class="icon" src="'+(results[i].identification.observation.taxon.default_photo?results[i].identification.observation.taxon.default_photo.url:'')+'" />');
         faddelem('td',brow,null,null,furl('https://www.inaturalist.org/taxa/'+results[i].identification.observation.taxon.id,results[i].identification.observation.taxon.name));
         //faddelem('td',brow,null,null,'');
         //faddelem('td',brow,null,null,results[i].identification.observation.taxon.rank);
         faddelem('td',brow,null,null,(results[i].identification.taxon.id===results[i].identification.observation.taxon.id?'✔':'❌'));
      };

      // buttons to go to prev or next page
      var buttons = faddelem('p',document.body);
      (page_curr<=1)?faddelem('span',buttons,'button_inactive',null,'⏮'):faddelem('span',buttons,'button',null,furl(fpageurl(winurlexsearchstr,winurlparams,per_page,1),'⏮'));
      (page_prev===null)?faddelem('span',buttons,'button_inactive',null,'◀'):faddelem('span',buttons,'button',null,furl(fpageurl(winurlexsearchstr,winurlparams,per_page,page_prev),'◀'));
      (page_next===null)?faddelem('span',buttons,'button_inactive',null,'▶'):faddelem('span',buttons,'button',null,furl(fpageurl(winurlexsearchstr,winurlparams,per_page,page_next),'▶'));
      (page_curr>=page_max)?faddelem('span',buttons,'button_inactive',null,'⏭'):faddelem('span',buttons,'button',null,furl(fpageurl(winurlexsearchstr,winurlparams,per_page,page_max),'⏭'));
   }
   else { faddelem('p',document.body,null,null,'No results returned.'); };
};

var apibase = 'https://api.inaturalist.org/v1/identifications/recent_taxa';
var apiurl = apibase+((winurlparams!='')?('?'+winurlparams):'');
var apirefurl = 'https://api.inaturalist.org/v1/docs/#!/Identifications/get_identifications_recent_taxa';
var apirefname = 'iNaturalist Identification Recent Taxa';
var apiref = furl(apirefurl,apirefname);
faddelem('h1',document.body,null,null,apirefname);

if (winurlsearchstr==='') {
   faddelem('p',document.body,null,null,'This page displays the response from the '+apiref+' API endpoint in a user-friendly format. To use this page, add at least one query parameter to the URL. See '+furl(apirefurl)+' for available query parameters.');
   faddelem('p',document.body,null,null,'Suppose the address of this page is '+winurlexsearchstr+', <br />and you want to see the results of '+furl(famp(apibase+'?taxon_id=47126&place_id=35&quality_grade=needs_id,research&rank=species&category=improving,leading&per_page=200'))+' in a friendly format, <br />then you would open '+furl(famp(winurlexsearchstr+'?taxon_id=47126&place_id=35&quality_grade=needs_id,research&rank=species&category=improving,leading&per_page=200'))+' in your browser.');
   faddelem('p',document.body,null,null,"Note that by default this API endpoint will return 10 records per page. You can override that by setting a per_page parameter in the URL up to 500. You can get the page you're interested in by setting the page parameter in the URL or by using the buttons at the bottom of the page.");
}
else {
   faddelem('p',document.body,null,null,'This is the base query: '+furl(famp(apiurl))+'. (This page will accept most parameters from the '+apiref+' API endpoint.)');
   fetch(apiurl)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
      .then((data) => { fresults(data); })
      .catch((err) => {
         console.error(err.message);
         faddelem('p',document.body,null,null,'There was a problem retrieving data. Error '+err.message+'.')
      });
};

</script>
</body>

</html>