<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="iNaturalist Map Observation Interaction Area Visualization.js" />
<title>iNaturalist Map Observation Interaction Area Visualization.js</title>
<style>
   body { height:100vh; width:100vw; margin:0px; }
   #nav { font:9pt Sans-serif; height:100vh; width:25vw; position:absolute; top:0vh; left:0vw; background:darkgray; }
   #mapid { height:100vh; width:75vw; position:absolute; top:0vh; left:25vw; background:darkgray; }
   p { margin:10px 10px 0px 10px; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
<script>

// debug grid example from https://leafletjs.com/examples/extending/extending-2-layers.html
L.GridLayer.DebugCoords = L.GridLayer.extend({
   createTile: function (coords) {
      var tile = document.createElement('div');
      tile.innerHTML = [coords.x, coords.y, coords.z].join(', ');
      tile.style.outline = '1px solid red';
      return tile;
   }
});
L.gridLayer.debugCoords = function(opts) {
   return new L.GridLayer.DebugCoords(opts);
};

// iNaturalist UTFGrid Density Map
function freplacexyz(url,x,y,z) {
   url = url.replace('{x}',x);
   url = url.replace('{y}',y);
   url = url.replace('{z}',z);
   return url;
};
L.GridLayer.UTFGridDensityMap = L.GridLayer.extend({
   createTile: function (coords, done) {

      var tile = document.createElement('canvas');
      var tileSize = this.getTileSize();
      tile.width = tileSize.x;
      tile.height = tileSize.y;
      var cellsPerTile = {x:64,y:64};
      var cellSize = {x:tileSize.x/cellsPerTile.x,y:tileSize.y/cellsPerTile.y};
      var ctx = tile.getContext('2d');

      // default marker setups
      var dmarker = {size:0.75,offset:{x:0,y:0},colorRGB:[0,255,0]};
      var marker = null;
      if (this.options.marker) {
         marker = this.options.marker;
         marker.size = marker.size || dmarker.size;
         marker.offset = marker.offset || dmarker.offset;
         marker.offset.x = marker.offset.x || dmarker.offset.x;
         marker.offset.y = marker.offset.y || dmarker.offset.y;
         marker.colorRGB = marker.colorRGB || dmarker.colorRGB;
      }
      else { marker = dmarker };
      var offset = marker.offset;

      // get UTFgrid
      var url = freplacexyz(this.options.url,coords.x,coords.y,coords.z);
      fetch(url)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+': '+response.statusText); };
         return response.json();
      })
      // draw markers on a canvas object
      .then((utfgrid) => {
         //draw markers on the tile canvas
         for (cx=0;cx<cellsPerTile.x;cx++) {
            for (cy=0;cy<cellsPerTile.y;cy++) {
               var cell = {x:cx,y:cy};
               //for details about decoding the UTFgrid, see https://github.com/mapbox/utfgrid-spec/blob/master/1.2/utfgrid.md
               var i = utfgrid.grid[cell.y].charCodeAt(cell.x);
               i = i-((i>=93)?34:(i>=35)?33:32);
               var d = utfgrid.data[utfgrid.keys[i]];
               var markerColor = 0; //default to black
               if (d!=null) {
                  var opacity = 0.5;
                  var markerColor = 'rgba('+marker.colorRGB+','+opacity+')'; //rgba format
                  ctx.fillStyle = markerColor;
                  ctx.fillRect(cell.x*cellSize.x+offset.x,cell.y*cellSize.y+offset.y,cellSize.x*marker.size,cellSize.y*marker.size);
               };
            };
         };
      })
      .catch((err) => { console.error(err); });

      // asynchronous call
      setTimeout(function() {
         done(null, tile);
      }, 1000);
      return tile;
   }
});
L.gridLayer.utfGridDensityMap = function (options) {
   return new L.GridLayer.UTFGridDensityMap(options);
};

</script>
</head>
<body>
<div id="nav">
<p>Markers in maps in iNaturalist are generally delivered as tiled image files, not actually as individual markers. This means that a user cannot directly interact with the markers displayed on the maps.</p>
<p>Instead, a user interacts with an invisible UTFgrid layer -- a grid of square cells -- that sits on top of the marker layer. The idea is that if a user interacts with a UTFgrid cell that is positioned on top of a particular marker, then the action triggered should correspond to an action meaningful for that marker.</p>
<p>The UTFgrid cells do not always approximate the shape of their corresponding markers correctly. This page provides a way to visualize the areas where an interaction can take place, alongside the corresponding markers that would be shown on an iNaturalist map.</p>
<p>A couple of notes: First, this page uses a different set of basemaps than those available in iNaturalist (since the ones that iNaturalist uses are not free). Second, the pin-style markers (that look like upside down teardrops) seem to be shifted down ever so slightly in the actual iNaturalist maps vs what can be achieved in this page. (The effect would be that the corresponding interaction area in iNaturalist would be the fat end of the pin vs the narrow tip of the pin in this page.) So you will just have to mentally shift those pins down a bit when you see them in this page.</p>
</div>
<div id="mapid"></div>

<script>

//get parameters from the url
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
let winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
var taxon_id = winurlparams.get('taxon_id');
taxon_id = (taxon_id===null?null:taxon_id.split(',')[0]);
var place_id = winurlparams.get('place_id');
place_id = (place_id===null?null:place_id.split(',')[0]);
var scale_factor = winurlparams.get('scale_factor');
if (scale_factor) {
   var sfarray = scale_factor.split(',');
   for (sf=1;sf<6;sf++) { if (sfarray.length<=sf) {sfarray.push(sfarray[sf-1]);}; };
};
var centerlat = winurlparams.get('centerlat') || 0;
var centerlng = winurlparams.get('centerlng') || 0;
var defaultzoom = winurlparams.get('defaultzoom') || 2;
var defaultstyle = winurlparams.get('defaultstyle') || 'opacity';
var hideleftpane = winurlparams.get('hideleftpane') || 'false';
var showtaxonplace = winurlparams.get('showtaxonplace') || 'false';
var showtaxonrange = winurlparams.get('showtaxonrange') || 'false';
var showplace = winurlparams.get('showplace') || 'false';

if (hideleftpane==='true') {
   var mapdiv = document.getElementById('mapid');
   mapdiv.style.left = '0vw';
   mapdiv.style.width = '100vw';
   var navdiv = document.getElementById('nav');
   navdiv.style.visibility = 'hidden';
};

winurlparams.delete('scale_factor');
winurlparams.delete('centerlat');
winurlparams.delete('centerlng');
winurlparams.delete('defaultzoom');
winurlparams.delete('defaultstyle');
winurlparams.delete('hideleftpane');
winurlparams.delete('showtaxonplace');
winurlparams.delete('showtaxonrange');
winurlparams.delete('showplace');

// iNat UTFGrid Visualization, using grid-style UTFGrid at lower zooms and point-style UTFGrid at higher zooms
let utfgridapi_grid = {url:'https://api.inaturalist.org/v1/grid/{z}/{x}/{y}.grid.json',attr:'<a href="https://api.inaturalist.org/v1/docs/#!/UTFGrid/get_grid_zoom_x_y_grid_json">iNaturalist</a>'};
let utfgridapi_points = {url:'https://api.inaturalist.org/v1/points/{z}/{x}/{y}.grid.json',attr:'<a href="https://api.inaturalist.org/v1/docs/#!/UTFGrid/get_points_zoom_x_y_grid_json">iNaturalist</a>'};
var l_utfgdm1 = L.gridLayer.utfGridDensityMap({url:utfgridapi_grid.url+'?'+winurlparams,minZoom:0,maxZoom:9,attribution:utfgridapi_grid.attr,marker:{size:0.90,colorRGB:[0,255,0]}})
var l_utfgdm2 = L.gridLayer.utfGridDensityMap({url:utfgridapi_points.url+'?'+winurlparams,minZoom:10,maxZoom:20,attribution:utfgridapi_grid.attr,marker:{size:0.90,colorRGB:[176,0,176]}})
var g_utfgdm = L.layerGroup([l_utfgdm1,l_utfgdm2]);

// iNat Observation Layer, using grid markers at lower zooms and points at higher zooms
let inat_urlbase = 'https://api.inaturalist.org/v1/';
//let inat_circles = {url:inat_urlbase+'colored_heatmap/{z}/{x}/{y}.png',description:'iNaturalist Observations (Density Circles)',attribution:'<a href="https://api.inaturalist.org/v1/docs/#!/Observation_Tiles/get_colored_heatmap_zoom_x_y_png">iNaturalist observation data</a>'};
//let inat_heat = {url:inat_urlbase+'heatmap/{z}/{x}/{y}.png',description:'iNaturalist Observations (Heatmap)',attribution:'<a href="https://api.inaturalist.org/v1/docs/#!/Observation_Tiles/get_heatmap_zoom_x_y_png">iNaturalist observation data</a>'};
//let gbif_density_point_py = {url:'https://api.gbif.org/v2/map/occurrence/density/{z}/{x}/{y}@1x.png?srs=EPSG:3857&style=purpleYellow.point&publishingOrg=28eb1a3f-1c15-4a95-931a-4af90ecb574d',description:'iNaturalist Observations in GBIF',attribution:'<a href="https://www.gbif.org/developer/maps">GBIF occurrence data</a>'};
//var l_inat_circles = L.tileLayer(inat_circles.url+'?'+winurlparams,{maxZoom:20,attribution:inat_circles.attribution});
//var l_inat_heat = L.tileLayer(inat_heat.url+'?'+winurlparams,{maxZoom:20, attribution:inat_heat.attribution});
//var l_gbif = L.tileLayer(gbif_density_point_py.url,{maxZoom:20, attribution:gbif_density_point_py.attribution});
let inat_points = {url:inat_urlbase+'points/{z}/{x}/{y}.png',description:'iNaturalist Observations (Points)',attribution:'<a href="https://api.inaturalist.org/v1/docs/#!/Observation_Tiles/get_points_zoom_x_y_png">iNaturalist observation data</a>'};
let inat_grid = {url:inat_urlbase+'grid/{z}/{x}/{y}.png',description:'iNaturalist Observations (Grid)',attribution:'<a href="https://api.inaturalist.org/v1/docs/#!/Observation_Tiles/get_grid_zoom_x_y_png">iNaturalist observation data</a>'};
var l_inat_points = L.tileLayer(inat_points.url+'?'+winurlparams,{minZoom:10,maxZoom:20, attribution:inat_points.attribution});
var l_inat_grid = L.tileLayer(inat_grid.url+'?'+winurlparams,{minZoom:0,maxZoom:9,attribution:inat_grid.attribution});
var g_inat_obs = L.layerGroup([l_inat_grid,l_inat_points]);

// Other iNaturalist Layers
var l_inat_place = L.tileLayer(inat_urlbase+'places/'+place_id+'/{z}/{x}/{y}.png',{maxZoom:20, attribution:'<a href="'+inat_urlbase+'docs/#!/Polygon_Tiles/get_places_place_id_zoom_x_y_png">iNaturalist place polygon</a>'});
/*
// iNaturalist Taxon Places Checklist and Range Layers
var l_inat_taxonplace = L.tileLayer(inat_urlbase+'taxon_places/'+taxon_id+'/{z}/{x}/{y}.png',{maxZoom:20, attribution:'<a href="'+inat_urlbase+'docs/#!/Polygon_Tiles/get_taxon_places_taxon_id_zoom_x_y_png">iNaturalist taxon place checklist data</a>'});
var l_inat_taxonrange = L.tileLayer(inat_urlbase+'taxon_ranges/'+taxon_id+'/{z}/{x}/{y}.png',{maxZoom:20, attribution:'<a href="'+inat_urlbase+'docs/#!/Polygon_Tiles/get_taxon_ranges_taxon_id_zoom_x_y_png">iNaturalist taxon range data</a>'});
*/

// Stamen layers
var s_stamen_copyright = 'Map tiles by <a href="https://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://www.openstreetmap.org/copyright">ODbL</a>.'; // used for all sets except Watercolor
var s_stamen_urlbase = 'https://stamen-tiles-{s}.a.ssl.fastly.net/';
var l_stamen_watercolor = L.tileLayer(s_stamen_urlbase+'watercolor/{z}/{x}/{y}.jpg',{maxZoom:20, attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'});
var l_stamen_terrain = L.tileLayer(s_stamen_urlbase+'terrain/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainbg = L.tileLayer(s_stamen_urlbase+'terrain-background/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlines = L.tileLayer(s_stamen_urlbase+'terrain-lines/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlabels = L.tileLayer(s_stamen_urlbase+'terrain-labels/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_toner = L.tileLayer(s_stamen_urlbase+'toner/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlite = L.tileLayer(s_stamen_urlbase+'toner-lite/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerbg = L.tileLayer(s_stamen_urlbase+'toner-background/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerhybrid = L.tileLayer(s_stamen_urlbase+'toner-hybrid/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlines = L.tileLayer(s_stamen_urlbase+'toner-lines/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlabels = L.tileLayer(s_stamen_urlbase+'toner-labels/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});

// OpenStreetMaps & OpenTopoMap
var l_osm_fr = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {maxZoom:20, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="https://openstreetmap.fr">OSM France</a>'});
var l_osm_hot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {maxZoom:19, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - Tiles courtesy of <a href="https://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'});
var l_otm = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxNativeZoom:17, attribution:'Kartendaten: &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>-Mitwirkende, SRTM | Kartendarstellung: &copy; <a href="http://opentopomap.org/">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});

//debug layer
var l_debug = L.gridLayer.debugCoords();

var defaultlayers = [l_stamen_toner];
/*
if (taxon_id!==null) {
   if (showtaxonplace==='true') {defaultlayers.push(l_inat_taxonplace)};
   if (showtaxonrange==='true') {defaultlayers.push(l_inat_taxonrange)};
};
*/
if (place_id!==null) { 
   if (showplace==='true') {defaultlayers.push(l_inat_place)};
};
defaultlayers.push(g_inat_obs);
defaultlayers.push(g_utfgdm);

// create map, and set default center coordinates, zoom level, and layers
var mymap = L.map('mapid', {
   center: [centerlat,centerlng],
   zoom: defaultzoom,
   layers: defaultlayers,
   doubleClickZoom: false
});

// define available basemaps (can view only one at a time)
var basemaps = {
   "Stamen Watercolor": l_stamen_watercolor,
   "Stamen Terrain Terrain": l_stamen_terrain,
   "Stamen Terrain Background": l_stamen_terrainbg,
   "Stamen Toner": l_stamen_toner,
   "Stamen Toner Background": l_stamen_tonerbg,
   "Stamen Toner Lite": l_stamen_tonerlite,
   "OpenTopoMap": l_otm,
   "OpenStreetMap France": l_osm_fr,
   "OpenStreetMap Humanitarian": l_osm_hot,
};

// define available overlay maps (can view more than one at a time, arranged in order from lowest to highest)
var overlaymaps = {
   "Stamen Terrain Lines": l_stamen_terrainlines,
   "Stamen Toner Lines": l_stamen_tonerlines,
   "Stamen Toner Hybrid": l_stamen_tonerhybrid,
   "Stamen Terrain Labels": l_stamen_terrainlabels,
   "Stamen Toner Labels": l_stamen_tonerlabels,
//   "iNaturalist Taxon Range": l_inat_taxonrange,
//   "iNaturalist Taxon Places": l_inat_taxonplace,
   "iNaturalist Place": l_inat_place,
//   "iNaturalist Observations Density in GBIF (no filters)": l_gbif,
//   "iNaturalist Observations Grid": l_inat_grid,
//   "iNaturalist Observations Heatmap": l_inat_heat,
//   "iNaturalist Observations Circles": l_inat_circles,
//   "iNaturalist Observations Points": l_inat_points,
   "iNaturalist Observations":g_inat_obs,
   "iNaturalist Obs Interaction Area":g_utfgdm,
   "Debug Grid":l_debug,
};
/*
if (taxon_id===null) {
   delete overlaymaps["iNaturalist Taxon Range"];
   delete overlaymaps["iNaturalist Taxon Places"];
};
*/
if (place_id===null) {
   delete overlaymaps["iNaturalist Place"];
};

// add a layer selector control and scale bar
L.control.layers(basemaps, overlaymaps).addTo(mymap);
L.control.scale().addTo(mymap);

</script>
</body>
</html>