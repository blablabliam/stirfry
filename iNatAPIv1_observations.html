<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="iNaturalist API Get Observations" />
<title>iNaturalist API Get Observations</title>
<style>
   body { font:10pt Sans-Serif; }
   #main { width:100%; }
   table, thead, tbody, tr, td, th { margin:0px; padding:3px; border-width:1px 0px;border-style:solid; border-color:lightgray; border-spacing:0px; border-collapse:collapse; }
   th { position:-webkit-sticky /*Safari*/; position:sticky; top:0; font-weight:600; background:forestgreen; color:white; text-align:left; vertical-align:bottom; }
   tr { background:whitesmoke; }
   tr:nth-child(even) { background-color:white }
   .tar { text-align:right; }
   .icon { height:48px; width:48px; border-radius:50%; }
   .photo { height:64px; width:64px; }
   img { margin:0px; padding:0px; border:0px; }
   a { text-decoration:none; color:royalblue; }
   .button, .button_inactive { display:inline-block; margin-right:5px; margin-top:8px; height:30px; width:30px; border:1px solid lightgray; border-radius:35%; font-size:18pt; vertical-align:middle; text-align:center; }
   .button { background:whitesmoke; }
   .button:hover { background:lightgray; }
   .button_inactive { background:none; color:lightgray; }
</style>
</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
let winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
//let p_per_page = winurlparams.get('per_page') || 200;
//let p_page = winurlparams.get('page') || 1;

function fdate(str,dateonly=false) {
   str = str.replace(/t/i,' '); //replaces T (case insensitive) with a space
   if (dateonly) { str = str.split(' ')[0]; }
   else {
      str = str.replace(/([+-]\d{2}\:?\d{2})/,' ($1)'); //puts parenthesis around time zone offset
      str = str.replace(/z/i,' (+00:00)'); //replaces Z (case insensitve) with UTC
      str = str.replace('+00:00','Â±00:00');
   };
   return str;
};
function furl(url,txt=url) { return '<a href="'+url+'">'+txt+'</a>'; };
function famp(str) { return str.replace(/&/g,'&amp;'); };
function fcomnum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',') };
function faddelem(etype,eparent=null,eattributes={}) {
   let eobj = document.createElement(etype);
   for (let [key,value] of Object.entries(eattributes)) {
      if ( typeof value === 'object' && value !== null ) {
         for (let [subkey,subvalue] of Object.entries(value)) { eobj[key][subkey] = subvalue; };
      }
      else { eobj[key] = value; };
    };
   if (eparent) { eparent.appendChild(eobj); };
   return eobj;
};
function faddelems(etype,eparent=null,eattributes=[]) { for (let e of eattributes) { faddelem(etype,eparent,e); }; };
function fpageurl(urlbase,urlparams,per_page,page) {
   let params = new URLSearchParams(urlparams);
   let url_per_page = params.get('per_page');
   let url_page = params.get('page');
   (url_per_page===null) ? params.append('per_page',per_page) : params.set('per_page',per_page);
   (url_page===null) ? params.append('page',page) : params.set('page',page);
   return urlbase+'?'+params;
};
function fpushifnew(ary,value) {
   if(!ary.includes(value)) { ary.push(value) };
   return ary.length;
};
function fidextra(obs) {
   let taxon = obs.taxon;
   let ids = obs.identifications;
   if (!ids || !taxon) { return null; }
   let taxa = {obs:[],ancestor:[],descendant:[],other:[]};
   let countall = 0;
   for (i=0;i<ids.length;i++) {
      if (ids[i].current && !ids[i].hidden) {
         countall++;
         let id = ids[i].taxon.id;
         if ( id===taxon.id ) { fpushifnew(taxa.obs,id); }
         else if ( taxon.ancestry.split('/').map(s=>Number(s)).includes(id) ) { fpushifnew(taxa.ancestor,id); }
         else if ( ids[i].taxon.ancestry.split('/').map(s=>Number(s)).includes(taxon.id) ) { fpushifnew(taxa.descendant,id); }
         else { fpushifnew(taxa.other,id); };
      };
   };
   return {count:{all:countall,by_others:obs.identifications_count},taxa};
};

function fresults(xobj) {
   //faddelem('p',document.body,{innerHTML:furl(famp(apiurl))});
   let results = xobj.results;
   if (results) {
      let total_results = xobj.total_results;
      let per_page = xobj.per_page;
      let page_curr = xobj.page;
      let page_max = Math.ceil(total_results/per_page);
      let page_prev = ((page_curr>1)?page_curr-1:null);
      let page_next = ((page_curr<page_max)?page_curr+1:null);

      faddelem('p',document.body,{innerHTML:'total observations: '+fcomnum(total_results)+'<br />'
         +'per page: '+fcomnum(per_page)+'<br />'
         +'page: '+fcomnum(page_curr)+' of '+fcomnum(page_max)+'<br />'
         });

      let table = faddelem('table',document.body,{id:'main'});
      let thead = faddelem('thead',table);
      let hrow = faddelem('tr',thead);
      let labels = [
         {innerText:'#'},
         {innerText:'ID'},
         {innerText:'Photo'},
         {innerText:'Name'},
         {innerText:'Common Name'},
         {innerText:'Rank'},
         {innerText:'Grade'},
         {classList:'tar',innerText:'ID Count'},
         {classList:'tar',innerText:'ID Taxa @ Obs'},
         {classList:'tar',innerText:'ID Taxa @ Ansc'},
         {classList:'tar',innerText:'ID Taxa @ Desc'},
         {classList:'tar',innerText:'ID Taxa @ Other'},
         {innerText:'User Photo'},
         {innerText:'User Login'},
         {innerText:'Observe Date'},
         {innerText:'Submit Date'},
         {innerText:'Update Date'},
         {innerText:'Coordinates'},
         {innerText:'Location Description'},
         {innerText:'Description'},
         {innerText:'Photo URLs'},
      ];
      faddelems('th',hrow,labels);
 
      let tbody = faddelem('tbody',table);
      for (let i=0; i<results.length; i++) {
         let brow = faddelem('tr',tbody);
         let rec = results[i];
         let idextra = fidextra(rec);
         let photos = [];
         if (rec.photos&&rec.photos.length>0) {
            for (let p=0; p<rec.photos.length; p++) {
               let url = (p>0)?' ':'';
               url += rec.photos[p].url.substring(0,rec.photos[p].url.search('\\?'));
               photos.push(furl(url.replace('square','medium'),url.replace('square','medium')));
            };
         };
         let values = [
            {innerText:i+1},
            {innerHTML:furl('https://www.inaturalist.org/observations/'+rec.id,rec.id)},
            {innerHTML:'<img class="photo" src="'+((rec.photos&&rec.photos.length>0)?rec.photos[0].url:'')+'" />'},
            {innerHTML:rec.taxon?furl('https://www.inaturalist.org/taxa/'+rec.taxon.id,rec.taxon.name):''},
            {innerText:rec.taxon?rec.taxon.preferred_common_name:''},
            {innerText:rec.taxon?rec.taxon.rank:''},
            {innerText:rec.quality_grade},
            {classList:'tar',innerText:(idextra===null)?0:idextra.count.all},
            {classList:'tar',innerText:(idextra===null)?'N/A':idextra.taxa.obs.length},
            {classList:'tar',innerText:(idextra===null)?'N/A':idextra.taxa.ancestor.length},
            {classList:'tar',innerText:(idextra===null)?'N/A':idextra.taxa.descendant.length},
            {classList:'tar',innerText:(idextra===null)?'N/A':idextra.taxa.other.length},
            {innerHTML:'<img class="icon" src="'+rec.user.icon+'" />'},
            {innerHTML:furl('https://www.inaturalist.org/people/'+rec.user.login,rec.user.login)},
            {innerText:(rec.time_observed_at?fdate(rec.time_observed_at):(rec.observed_on||''))},
            {innerText:(fdate(rec.created_at||rec.created_at_details.date))},
            {innerText:fdate(rec.updated_at)},
            {innerText:rec.location?rec.location.replace(',',', '):''},
            {innerText:rec.place_guess},
            {innerText:rec.description},
            {innerHTML:photos.toString()},
         ];
         faddelems('td',brow,values);
      };

      // buttons to go to prev or next page
      let nav = faddelem('div',document.body);
      let buttons = [
         (page_curr<=1)?{classList:'button_inactive',title:'first',innerHTML:'&laquo'}:{classList:'button',title:'first',innerHTML:'&laquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,1)},
         (page_prev===null)?{classList:'button_inactive',title:'previous',innerHTML:'&#8249'}:{classList:'button',title:'previous',innerHTML:'&#8249',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_prev)},
         (page_next===null)?{classList:'button_inactive',title:'next',innerHTML:'&#8250'}:{classList:'button',title:'next',innerHTML:'&#8250',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_next)},
         (page_curr>=page_max)?{classList:'button_inactive',title:'last',innerHTML:'&raquo'}:{classList:'button',title:'last',innerHTML:'&raquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_max)},
      ];
      faddelems('a',nav,buttons);
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); };
};
let apibase = 'https://api.inaturalist.org/v1/observations';
let apiurl = apibase+((winurlparams!='')?('?'+winurlparams):'');
let apirefurl = 'https://api.inaturalist.org/v1/docs/#!/Observations/get_observations';
let apirefname = 'iNaturalist Observations';
let apiref = furl(apirefurl,apirefname);
faddelem('h1',document.body,{innerText:apirefname});

if (window.location.search==='') {
   let instructions = [
      {innerHTML:'This page displays the response from the '+apiref+' API endpoint in a human-readable format. To use this page, add at least one query parameter to the URL. See '+furl(apirefurl)+' for available query parameters.'},
      {innerHTML:'Suppose the address of this page is '+winurlexsearchstr+', <br />and you want to see the results of '+furl(famp(apibase+'?user_id=bob&per_page=200'))+' in a friendly format, <br />then you would open '+furl(famp(winurlexsearchstr+'?user_id=bob&per_page=200'))+' in your browser.'},
      {innerHTML:'Note that the API will not return records beyond the 10,000th record for a given set of parameters, but you can work around this by using the id_above and id_below parameters.'},
   ];
   faddelems('p',document.body,instructions);
}
else {
   faddelem('p',document.body,{innerHTML:'This is the base query: '+furl(famp(apiurl))+'. (This page will accept most parameters from the '+apiref+' API endpoint.)'});
   fetch(apiurl)
   .then((response) => {
      if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
      return response.json();
   })
   .then((data) => { fresults(data); })
   .catch((err) => {
      console.error(err.message);
      faddelem('p',document.body,{innerText:'There was a problem retrieving data. Error '+err.message+'.'})
   });
};
</script>
</body>

</html>